<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Vending Machine</title>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css">

	<link rel="stylesheet" href="stylesheet.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

	<script src="../Lib/MustacheJs/src/js/mustache.js"></script>
	<script src="cash.js"></script>
	<script src="vending_machine.js"></script>

</head>
<body>

<!--Определение шапки-->
<nav role="navigation" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" data-target="#navbarCollapse" data-toggle="collapse" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="#" class="navbar-brand">Brand</a>
        </div>
        <div id="navbarCollapse" class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li class="active"><a href="#">Home</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="jumbotron">
    <div class="container">
        <h1>The Vending Machine</h1>
        <p>The Vending Machine is </p>
    </div>
</div>

<!--Определение контента, который содержит контейнер вендинговой машины и кошелька покупателя-->
<div class="container">
	<div class="row">
		<div class="col-lg-10">
			<div class="coffee-vending-machine-container">
				
			</div>
		</div>
		<div class="col-lg-2">
			<h1>Consumer Cash</h1>
			<div class="consumer-container">

			</div>
		</div>
	</div>
</div>

<script type="text/javascript">

	function Consumer(data){
		this.cash = new Cash(data);
	};

	function Message(text, status){
		return {text: text, status: status};
	}

	//Определение функций, возвращающих как-бы json данные
	function getConsumerCashJson(){
		return {
			coins: [
				{rating: '10 рублей', count: 5, value: 10},
				{rating: '1 рубль', count: 10, value: 1},
				{rating: '2 рубля', count: 2, value: 2},
				{rating: '5 рублей', count: 11, value: 5}
			]
		};
	};
	
	function getVendingMachineCashJson(){
		return {
			coins: [
				{rating: '10 рублей', count: 5, value: 10},
				{rating: '1 рубль', count: 10, value: 1},
				{rating: '2 рубля', count: 2, value: 2},
				{rating: '5 рублей', count: 11, value: 5}
			]
		};
	};

	function getProductListJson(){
		return {
			products: [
				{ id: 1, name: 'Кофе', count: 5, price: 10 },
				{ id: 2, name: 'Кофе с молоком', count: 10, price: 1 },
				{ id: 3, name: 'Чай', count: 2, price: 2 },
				{ id: 4, name: 'Сок', count: 11, price: 5 }
			]
		};
	};

	//После того, как документ загружен
	$(function(){

		//Определение jquery переменных
		var $consumerContainer = $('.consumer-container');
		var $coffeeVendingMachineContainer = $('.coffee-vending-machine-container');

		//Emulation of getting Json data from some server;
		var consumerCash = getConsumerCashJson();
		var vendingMachineCash = getVendingMachineCashJson();
		var productList = getProductListJson();

		//Вставка шаблона вендинговой машины
		var vendingMachineTemplate = $('#vending-machine-template').html();
		var renderedVendingMustacheTemplate = Mustache.render(vendingMachineTemplate, productList);

		$coffeeVendingMachineContainer.html(renderedVendingMustacheTemplate);

		//Вставка шаблона кошелька покупателя
		var consumerTemplate = $('#consumer-template').html();
		var renderedConsumerTemplate = Mustache.render(consumerTemplate, consumerCash);

		$consumerContainer.html(renderedConsumerTemplate);

		//Инициализация покупателя и вендинговой машины
		var consumer = new Consumer(consumerCash.coins);
		var vendingMachine = new VendingMachine( productList.products, vendingMachineCash.coins );

		//Определение обработчиков вендинговой машины
		$coffeeVendingMachineContainer.on('click', '.change', function(event){
			
			var $target = $(event.target);
			var $digit = $coffeeVendingMachineContainer.find('.digit');
			var $message = $coffeeVendingMachineContainer.find('.message');

			console.log(vendingMachine.giveChange());
			var payment = vendingMachine.getPayment();

			$digit.find('.digit-value').html(payment);
			$message.html('Спасибо!');
		});

		$coffeeVendingMachineContainer.on('click', '.product-list li', function(event){
			
			var $target = $(event.target);

			console.log($target);
			var $digit = $coffeeVendingMachineContainer.find('.digit');
			var $message = $coffeeVendingMachineContainer.find('.message');

			var product = vendingMachine.getProduct($target.attr('data-id'));
			var payment = vendingMachine.getPayment();

			if( product === VendingMachine.PRODUCT_IS_NOT_DEFINED ){
				console.log('Продукт не определен');
				return false;
			}else if( product === VendingMachine.NOT_ENOUGH_MONEY ){
				$message.html('Недостаточно средств!');
				return false;
			}else if( product === VendingMachine.PRODUCT_ENDED ){
				$message.html('Продукт закончился');
				return false;
			}

			$digit.find('.digit-value').html(payment);
			$message.html('Спасибо!');
		});

		//Определение обработчиков кошелька покупателя
		$consumerContainer.on('click', '.coins', function(event){

			var $digit = $coffeeVendingMachineContainer.find('.digit');

			$target = $(event.target);

			var number = 1;
			var rating = $target.attr('data-rating');

			var consumerNumberOfCoinsByRating = consumer.cash.decreaseNumberOfCoinByRating(rating);
			var vendingNumberOfCoinsByRating = vendingMachine.putMoney(rating, number);

			$digit.find('.digit-value').html(vendingNumberOfCoinsByRating);
			$target.find('.badge').html(consumerNumberOfCoinsByRating);
		});
	});

</script>

<!--Определение шаблона вендинговой машины-->
<script id="vending-machine-template" type="text/html">
	<div class="coffee-vending-machine">
		<div class="scoreboard">
			<div class="message"></div>
			<div class="digit">
				<span>Внесенная сумма: </span>
				<span class="digit-value"></span>
			</div>
		</div>
		<div class="glass-case">
			<div class="product-list">
				<ul class="list-group">
					{{#products}}
						<li class="list-group-item" data-id='{{id}}'>
							<div class="product-image">{{img}}</div>
							<div class="product-info">
								<span class="product-name">{{name}}</span>
								<span class="product-price">{{price}}</span>
							</div>
						</li>
					{{/products}}
				</ul>
			</div>
		</div>
		<div class="keyboard">
			<a class="btn btn-default change">Сдача</a>
		</div>
		<div class="footer">
			dfgdgdgdfgdfg
		</div>
	</div>
</script>

<!--Определение шаблона кошелька покупателя-->
<script id="consumer-template" type="text/html">
	<div class="consumer">
		<div class="consumer-cash">
			<ul class="list-of-coins-by-rating list-group">
				{{#coins}}
					<li class="coins list-group-item" data-rating="{{rating}}">{{rating}}<span class="badge">{{count}}</span></li>
				{{/coins}}
			</ul>
		</div>
	</div>
</script>

</body>
</html>